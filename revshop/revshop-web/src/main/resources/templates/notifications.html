<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout('Notifications', ~{::section})}">

<section>

    <h2>Notifications</h2>

    <div id="notificationContainer"></div>

    <!-- Enable Thymeleaf inline JavaScript -->
    <script th:inline="javascript">

        // Get logged-in userId from session
        const userId = /*[[${session.userId}]]*/ null;

        function loadNotifications() {

            const container = document.getElementById("notificationContainer");
            container.innerHTML = "";

            // If user not logged in
            if (!userId) {
                container.innerHTML = "<p>Please login to view notifications.</p>";
                return;
            }

            fetch(`http://localhost:8080/api/notifications/${userId}`)
                .then(res => res.json())
                .then(data => {

                    // If no notifications found
                    if (!data || data.length === 0) {
                        container.innerHTML = "<p>No notifications available.</p>";
                        updateBadge(0);
                        return;
                    }

                    let unreadCount = 0;

                    data.forEach(n => {

                        const card = document.createElement("div");
                        card.style.border = "1px solid #ddd";
                        card.style.padding = "15px";
                        card.style.marginBottom = "12px";
                        card.style.borderRadius = "12px";
                        card.style.cursor = "pointer";

                        if (!n.seen) {
                            card.style.backgroundColor = "#e8f1ff";
                            unreadCount++;
                        }

                        card.innerHTML = `
                            <div>
                                <strong>${n.title ?? ''}</strong>
                                <p>${n.message ?? ''}</p>
                                <small>${n.createdAt ?? ''}</small>
                            </div>
                        `;

                        // Mark as seen when clicked
                        card.onclick = function () {
                            fetch(`http://localhost:8080/api/notifications/seen/${n.id}`, {
                                method: "PUT"
                            }).then(() => loadNotifications());
                        };

                        container.appendChild(card);
                    });

                    updateBadge(unreadCount);
                })
                .catch(() => {
                    container.innerHTML = "<p>Error loading notifications.</p>";
                });
        }

        function updateBadge(count) {

            const badge = document.getElementById("notificationCount");
            if (!badge) return;

            if (count > 0) {
                badge.style.display = "block";
                badge.innerText = count;
            } else {
                badge.style.display = "none";
            }
        }

        // Safe event listener (no conflicts with header)
        window.addEventListener("load", loadNotifications);

    </script>

</section>

</html>