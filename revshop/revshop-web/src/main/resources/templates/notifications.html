<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout('Notifications', ~{::section})}">

<section>

    <h2 style="margin-bottom:20px;">Notifications</h2>

    <div id="notificationContainer"></div>

    <script th:inline="javascript">

        const userId = /*[[${session.userId}]]*/ null;

        function loadNotifications() {

            const container = document.getElementById("notificationContainer");
            container.innerHTML = "";

            if (!userId) {
                container.innerHTML = "<p>Please login to view notifications.</p>";
                return;
            }

            fetch(`http://localhost:8080/api/notifications/${userId}`)
                .then(res => res.json())
                .then(data => {

                    if (!data || data.length === 0) {
                        container.innerHTML = "<p>No notifications available.</p>";
                        updateBadge(0);
                        return;
                    }

                    let unreadCount = 0;

                    data.forEach(n => {

                        const card = document.createElement("div");
                        card.style.padding = "15px";
                        card.style.marginBottom = "10px";
                        card.style.borderRadius = "8px";
                        card.style.cursor = "pointer";
                        card.style.border = "1px solid #e0e0e0";

                        // ðŸ”¥ Unseen notification style (Ecommerce look)
                        if (!n.seen) {
                            card.style.backgroundColor = "#f3f3f3";  // soft grey
                            unreadCount++;
                        } else {
                            card.style.backgroundColor = "#ffffff";
                        }

                        card.innerHTML = `
                            <div style="${!n.seen ? 'font-weight:600;' : ''}">
                                ${n.title ?? ''}
                            </div>
                            <div style="margin-top:5px; ${!n.seen ? 'font-weight:600;' : ''}">
                                ${n.message ?? ''}
                            </div>
                            <small style="color:gray;">
                                ${n.createdAt ?? ''}
                            </small>
                        `;

                        // Mark only THIS notification as seen when clicked
                        card.onclick = function () {
                            fetch(`http://localhost:8080/api/notifications/seen/${n.id}`, {
                                method: "PUT"
                            }).then(() => loadNotifications());
                        };

                        container.appendChild(card);
                    });

                    updateBadge(unreadCount);
                })
                .catch(() => {
                    container.innerHTML = "<p>Error loading notifications.</p>";
                });
        }

        function updateBadge(count) {

            const badge = document.getElementById("notificationCount");
            if (!badge) return;

            if (count > 0) {
                badge.style.display = "block";
                badge.innerText = count;
            } else {
                badge.style.display = "none";
            }
        }

        window.addEventListener("load", loadNotifications);

    </script>

</section>

</html>